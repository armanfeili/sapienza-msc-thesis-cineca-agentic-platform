# Cineca Agentic Platform - Full Architecture Diagram

> **Version**: 1.0  
> **Last Updated**: January 2026  
> **Author**: Arman Feili

---

## Table of Contents

1. [High-Level Architecture Overview](#high-level-architecture-overview)
2. [Three-Layer Architecture](#three-layer-architecture)
3. [Component Interaction Diagram](#component-interaction-diagram)
4. [Request Flow Architecture](#request-flow-architecture)
5. [Data Flow Architecture](#data-flow-architecture)
6. [Security Architecture](#security-architecture)
7. [Orchestrator Architecture](#orchestrator-architecture)
8. [MCP Tools Architecture](#mcp-tools-architecture)
9. [Background Jobs Architecture](#background-jobs-architecture)
10. [Observability Architecture](#observability-architecture)
11. [Deployment Topology](#deployment-topology)
12. [Database Schema Overview](#database-schema-overview)

---

## High-Level Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                           CINECA AGENTIC PLATFORM - FULL ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                   CLIENT LAYER                                       │    │
│  │  ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐           │    │
│  │  │   Next.js Agent   │    │ Streamlit Control │    │    API Clients    │           │    │
│  │  │     Chat UI       │    │      Panel        │    │   (curl, SDK)     │           │    │
│  │  │    (Port 3002)    │    │   (Port 8501)     │    │                   │           │    │
│  │  └─────────┬─────────┘    └─────────┬─────────┘    └─────────┬─────────┘           │    │
│  └────────────┼──────────────────────────┼──────────────────────┼──────────────────────┘    │
│               │                          │                      │                           │
│               └──────────────────────────┼──────────────────────┘                           │
│                                          ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                              API GATEWAY LAYER                                       │    │
│  │  ┌───────────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                           NGINX REVERSE PROXY                                  │  │    │
│  │  │    • SSL/TLS Termination  • Load Balancing  • Rate Limiting  • CORS           │  │    │
│  │  └───────────────────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────┬───────────────────────────────────────────┘    │
│                                            │                                                 │
│                                            ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                              FASTAPI BACKEND (Port 8000)                             │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                              MIDDLEWARE STACK                                │    │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │    │    │
│  │  │  │  CORS    │→│  Trace   │→│   Auth   │→│   Rate   │→│  Error   │          │    │    │
│  │  │  │ Handler  │ │  Context │ │   JWT    │ │  Limit   │ │ Handler  │          │    │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────┘    │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                              API ROUTERS (76 Endpoints)                      │    │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │    │    │
│  │  │  │  Agent   │ │   Jobs   │ │  Models  │ │   MCP    │ │  Health  │          │    │    │
│  │  │  │   Runs   │ │          │ │Providers │ │  Tools   │ │          │          │    │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │    │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │    │    │
│  │  │  │ Sessions │ │ Tenants  │ │   Auth   │ │  Admin   │ │  Graph   │          │    │    │
│  │  │  │          │ │          │ │          │ │          │ │  Query   │          │    │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘          │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────┘    │
│                                            │                                                 │
│               ┌────────────────────────────┼────────────────────────────┐                   │
│               │                            │                            │                   │
│               ▼                            ▼                            ▼                   │
│  ┌────────────────────────┐  ┌────────────────────────┐  ┌────────────────────────┐        │
│  │    SERVICE LAYER       │  │   SECURITY LAYER       │  │   OBSERVABILITY        │        │
│  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │        │
│  │  │   Orchestrator   │  │  │  │   RBAC Engine    │  │  │  │    Prometheus    │  │        │
│  │  │   (8,263 LOC)    │  │  │  │                  │  │  │  │     Metrics      │  │        │
│  │  └──────────────────┘  │  │  └──────────────────┘  │  │  └──────────────────┘  │        │
│  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │        │
│  │  │   MCP Runtime    │  │  │  │  PII Scrubber    │  │  │  │  OpenTelemetry   │  │        │
│  │  │   (34 Tools)     │  │  │  │                  │  │  │  │    Tracing       │  │        │
│  │  └──────────────────┘  │  │  └──────────────────┘  │  │  └──────────────────┘  │        │
│  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │        │
│  │  │   LLM Adapter    │  │  │  │  Output Guard    │  │  │  │   Structured     │  │        │
│  │  │   + Resilience   │  │  │  │                  │  │  │  │    Logging       │  │        │
│  │  └──────────────────┘  │  │  └──────────────────┘  │  │  └──────────────────┘  │        │
│  └────────────────────────┘  └────────────────────────┘  └────────────────────────┘        │
│                                            │                                                 │
│               ┌────────────────────────────┼────────────────────────────┐                   │
│               │                            │                            │                   │
│               ▼                            ▼                            ▼                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                   DATA LAYER                                         │    │
│  │  ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐           │    │
│  │  │    PostgreSQL     │    │      Redis        │    │     Memgraph      │           │    │
│  │  │  (Control Plane)  │    │   (Data Plane)    │    │   (Graph DB)      │           │    │
│  │  │    Port 5432      │    │    Port 6379      │    │    Port 7687      │           │    │
│  │  │                   │    │                   │    │                   │           │    │
│  │  │ • Tenants         │    │ • Session Cache   │    │ • Domain Schema   │           │    │
│  │  │ • Agent Runs      │    │ • Job Queues      │    │ • NL→Cypher       │           │    │
│  │  │ • Steps           │    │ • Rate Limits     │    │ • Graph Analytics │           │    │
│  │  │ • Jobs            │    │ • Idempotency     │    │ • CRUD Ops        │           │    │
│  │  │ • Tool Manifests  │    │ • Cancel Flags    │    │ • ETL Pipeline    │           │    │
│  │  │ • Audit Logs      │    │ • Circuit Breaker │    │                   │           │    │
│  │  │ • Model Defaults  │    │                   │    │                   │           │    │
│  │  └───────────────────┘    └───────────────────┘    └───────────────────┘           │    │
│  └─────────────────────────────────────────────────────────────────────────────────────┘    │
│                                            │                                                 │
│               ┌────────────────────────────┼────────────────────────────┐                   │
│               │                            │                            │                   │
│               ▼                            ▼                            ▼                   │
│  ┌────────────────────────┐  ┌────────────────────────┐  ┌────────────────────────┐        │
│  │   WORKER LAYER         │  │   EXTERNAL SERVICES    │  │   MONITORING STACK     │        │
│  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │        │
│  │  │   Jobs Worker    │  │  │  │   LLM Providers  │  │  │  │     Grafana      │  │        │
│  │  │                  │  │  │  │  • OpenAI        │  │  │  │   (Port 3000)    │  │        │
│  │  └──────────────────┘  │  │  │  • Ollama        │  │  │  └──────────────────┘  │        │
│  │  ┌──────────────────┐  │  │  │  • Azure OpenAI  │  │  │  ┌──────────────────┐  │        │
│  │  │ Background Tasks │  │  │  └──────────────────┘  │  │  │    Prometheus    │  │        │
│  │  │  • Health Check  │  │  │  ┌──────────────────┐  │  │  │   (Port 9090)    │  │        │
│  │  │  • Cleanup       │  │  │  │     Auth0        │  │  │  └──────────────────┘  │        │
│  │  │  • Backup        │  │  │  │   (OIDC/JWT)     │  │  │  ┌──────────────────┐  │        │
│  │  └──────────────────┘  │  │  └──────────────────┘  │  │  │     Jaeger       │  │        │
│  └────────────────────────┘  └────────────────────────┘  │  │    (Tracing)     │  │        │
│                                                          │  └──────────────────┘  │        │
│                                                          └────────────────────────┘        │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Three-Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              THREE-LAYER ARCHITECTURE                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  ║                         PRESENTATION LAYER (UI + API)                            ║    │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  │                                                                                   │    │
│  │   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────────────┐   │    │
│  │   │  Agent Chat UI  │   │ Control Panel   │   │      REST API (v1/v2)       │   │    │
│  │   │    (Next.js)    │   │   (Streamlit)   │   │         FastAPI             │   │    │
│  │   │                 │   │                 │   │                             │   │    │
│  │   │ • Chat Interface│   │ • Admin CRUD    │   │ • 76 Endpoints              │   │    │
│  │   │ • SSE Streaming │   │ • Monitoring    │   │ • OpenAPI 3.1               │   │    │
│  │   │ • Auth Flow     │   │ • Configuration │   │ • JWT Auth                  │   │    │
│  │   └─────────────────┘   └─────────────────┘   └─────────────────────────────┘   │    │
│  │                                                                                   │    │
│  └───────────────────────────────────────────────────────────────────────────────────┘    │
│                                          │                                               │
│                                          ▼                                               │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  ║                          BUSINESS LOGIC LAYER (Services)                         ║    │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  │                                                                                   │    │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                        ORCHESTRATOR ENGINE                               │   │    │
│  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │    │
│  │   │  │   Intent    │  │    TODO     │  │    Step     │  │  Response   │    │   │    │
│  │   │  │ Classifier  │→ │  Planner    │→ │  Executor   │→ │  Builder    │    │   │    │
│  │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │    │
│  │   └─────────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                                   │    │
│  │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │    │
│  │   │  LLM Adapter  │ │  MCP Runtime  │ │   Security    │ │  Jobs Service │       │    │
│  │   │               │ │               │ │   Service     │ │               │       │    │
│  │   │ • Multi-model │ │ • 34 Tools    │ │ • RBAC        │ │ • Queue       │       │    │
│  │   │ • Fallback    │ │ • Categories  │ │ • PII         │ │ • SSE         │       │    │
│  │   │ • Circuit Brk │ │ • Validation  │ │ • Audit       │ │ • Cancel      │       │    │
│  │   └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘       │    │
│  │                                                                                   │    │
│  └───────────────────────────────────────────────────────────────────────────────────┘    │
│                                          │                                               │
│                                          ▼                                               │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  ║                           DATA PERSISTENCE LAYER                                 ║    │
│  ═══════════════════════════════════════════════════════════════════════════════════    │
│  │                                                                                   │    │
│  │   ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐       │    │
│  │   │  CONTROL PLANE      │ │    DATA PLANE       │ │    GRAPH DOMAIN     │       │    │
│  │   │    (PostgreSQL)     │ │      (Redis)        │ │     (Memgraph)      │       │    │
│  │   │                     │ │                     │ │                     │       │    │
│  │   │ ┌─────────────────┐ │ │ ┌─────────────────┐ │ │ ┌─────────────────┐ │       │    │
│  │   │ │  Repositories   │ │ │ │   Cache Layer   │ │ │ │  Graph Schema   │ │       │    │
│  │   │ │ • agents.py     │ │ │ │ • sessions      │ │ │ │ • Nodes         │ │       │    │
│  │   │ │ • jobs.py       │ │ │ │ • responses     │ │ │ │ • Relationships │ │       │    │
│  │   │ │ • tenants.py    │ │ │ │ • tool_results  │ │ │ │ • Properties    │ │       │    │
│  │   │ │ • tools.py      │ │ │ └─────────────────┘ │ │ └─────────────────┘ │       │    │
│  │   │ │ • models.py     │ │ │ ┌─────────────────┐ │ │ ┌─────────────────┐ │       │    │
│  │   │ └─────────────────┘ │ │ │   Queue Layer   │ │ │ │  NL→Cypher      │ │       │    │
│  │   │ ┌─────────────────┐ │ │ │ • job_queue     │ │ │ │ • Generation    │ │       │    │
│  │   │ │   Migrations    │ │ │ │ • event_buffer  │ │ │ │ • Validation    │ │       │    │
│  │   │ │   (Alembic)     │ │ │ │ • sse_ring      │ │ │ │ • Execution     │ │       │    │
│  │   │ └─────────────────┘ │ │ └─────────────────┘ │ │ └─────────────────┘ │       │    │
│  │   └─────────────────────┘ └─────────────────────┘ └─────────────────────┘       │    │
│  │                                                                                   │    │
│  └───────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           COMPONENT INTERACTION DIAGRAM                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│                                    ┌─────────────────┐                                  │
│                                    │     Client      │                                  │
│                                    │   (Browser)     │                                  │
│                                    └────────┬────────┘                                  │
│                                             │                                           │
│                           ┌─────────────────┼─────────────────┐                        │
│                           │                 │                 │                        │
│                           ▼                 ▼                 ▼                        │
│              ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│              │  Agent Chat UI  │  │ Control Panel   │  │   Direct API    │            │
│              │    (Next.js)    │  │  (Streamlit)    │  │    (curl)       │            │
│              └────────┬────────┘  └────────┬────────┘  └────────┬────────┘            │
│                       │                    │                    │                      │
│                       └────────────────────┼────────────────────┘                      │
│                                            │                                           │
│                                            ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    NGINX                                         │  │
│  │                              (Reverse Proxy)                                     │  │
│  └─────────────────────────────────────┬───────────────────────────────────────────┘  │
│                                        │                                               │
│                                        ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              FASTAPI APP                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐    │  │
│  │  │                           MIDDLEWARE                                     │    │  │
│  │  │   Auth ──► Rate Limit ──► Trace ──► Error ──► Request Handler           │    │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘    │  │
│  │                                     │                                            │  │
│  │                    ┌────────────────┼────────────────┐                          │  │
│  │                    │                │                │                          │  │
│  │                    ▼                ▼                ▼                          │  │
│  │  ┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐           │  │
│  │  │   Agent Runs API    │ │    Jobs API     │ │   Other APIs        │           │  │
│  │  │  POST /agent-runs   │ │  POST /jobs     │ │ /tools, /models,    │           │  │
│  │  │  GET /agent-runs/id │ │  GET /jobs/id   │ │ /tenants, /health   │           │  │
│  │  └──────────┬──────────┘ └────────┬────────┘ └─────────────────────┘           │  │
│  └─────────────┼─────────────────────┼─────────────────────────────────────────────┘  │
│                │                     │                                                 │
│                │     ┌───────────────┘                                                 │
│                │     │                                                                 │
│                ▼     ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              ORCHESTRATOR                                        │  │
│  │                                                                                  │  │
│  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │  │
│  │   │    Intent    │───▶│     TODO     │───▶│    Step      │───▶│   Response   │ │  │
│  │   │  Classifier  │    │   Planner    │    │   Executor   │    │   Builder    │ │  │
│  │   └──────────────┘    └──────────────┘    └──────┬───────┘    └──────────────┘ │  │
│  │                                                  │                              │  │
│  │                         ┌────────────────────────┼────────────────────────┐     │  │
│  │                         │                        │                        │     │  │
│  │                         ▼                        ▼                        ▼     │  │
│  │               ┌──────────────────┐    ┌──────────────────┐    ┌──────────────┐ │  │
│  │               │    LLM Client    │    │    MCP Tools     │    │ Graph Access │ │  │
│  │               │   (with retry)   │    │   (34 tools)     │    │  (Memgraph)  │ │  │
│  │               └────────┬─────────┘    └────────┬─────────┘    └──────┬───────┘ │  │
│  └────────────────────────┼───────────────────────┼─────────────────────┼─────────┘  │
│                           │                       │                     │            │
│        ┌──────────────────┘                       │                     │            │
│        │                                          │                     │            │
│        ▼                                          ▼                     ▼            │
│  ┌───────────────┐                      ┌───────────────┐      ┌───────────────┐    │
│  │ LLM Providers │                      │    Redis      │      │   Memgraph    │    │
│  │ • OpenAI      │                      │ • Cache       │      │ • Graph DB    │    │
│  │ • Ollama      │                      │ • Queue       │      │ • NL→Cypher   │    │
│  │ • Azure       │                      │ • State       │      │               │    │
│  └───────────────┘                      └───────────────┘      └───────────────┘    │
│                                                                                      │
│                           ┌───────────────────────────────────┐                     │
│                           │          PostgreSQL               │                     │
│                           │  • Runs  • Steps  • Jobs  • Logs  │                     │
│                           └───────────────────────────────────┘                     │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Request Flow Architecture

### Workflow A: Synchronous Agent Runs

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                      WORKFLOW A: SYNCHRONOUS AGENT RUNS                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌──────────┐                                                                           │
│  │  Client  │                                                                           │
│  └────┬─────┘                                                                           │
│       │                                                                                  │
│       │ 1. POST /v1/agent-runs                                                          │
│       │    {prompt: "...", temperature: 0.2}                                            │
│       ▼                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              FASTAPI ENDPOINT                                    │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 2. Middleware Chain                                                         │ │   │
│  │  │    ├─ JWT Validation ────► Principal extracted                             │ │   │
│  │  │    ├─ Rate Limiting ─────► Allowed (or 429)                                │ │   │
│  │  │    ├─ Readiness Check ───► Orchestrator ready (or 503)                     │ │   │
│  │  │    └─ Idempotency ───────► Cache check                                     │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 3. Request Processing                                                       │ │   │
│  │  │    ├─ Validate CreateRunRequest schema                                     │ │   │
│  │  │    ├─ Get/Create Session                                                   │ │   │
│  │  │    ├─ Load model defaults from DB                                          │ │   │
│  │  │    ├─ Create AgentRun record (status=queued)                               │ │   │
│  │  │    └─ Schedule BackgroundTask                                              │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                                  │   │
│  │  4. Return HTTP 201 {run_id, status: "queued"} ◄────────────────────────────────┘   │
│  └────────────────┬────────────────────────────────────────────────────────────────┘   │
│                   │                                                                     │
│                   │ (async in same process)                                             │
│                   ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         BACKGROUND TASK                                          │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 5. execute_agent_run_background()                                           │ │   │
│  │  │    ├─ Update status: queued → running                                      │ │   │
│  │  │    ├─ Initialize Orchestrator.from_env()                                   │ │   │
│  │  │    └─ Start orchestration with timeout                                     │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                    │                                             │   │
│  │                                    ▼                                             │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 6. Orchestrator.run()                                                       │ │   │
│  │  │    ├─ Intent Classification ──► {chat|graph|security|admin|dangerous}      │ │   │
│  │  │    ├─ TODO Planning (LLM) ────► [{task, status, meta}...]                  │ │   │
│  │  │    ├─ Step Execution ─────────► LLM calls, MCP tools, Graph queries        │ │   │
│  │  │    └─ Response Generation ────► Final output text                          │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 7. Finalization                                                             │ │   │
│  │  │    ├─ Update status: running → succeeded/failed                            │ │   │
│  │  │    ├─ Persist output, todos, steps, metrics                                │ │   │
│  │  │    ├─ Record provenance event                                              │ │   │
│  │  │    └─ Emit Prometheus metrics                                              │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌──────────┐                                                                           │
│  │  Client  │ 8. Poll GET /v1/agent-runs/{id} until status=succeeded                    │
│  └──────────┘    Returns: {output, todos, steps, metrics}                               │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### Workflow B: Asynchronous Jobs

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        WORKFLOW B: ASYNCHRONOUS JOBS                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌──────────┐                                                                           │
│  │  Client  │                                                                           │
│  └────┬─────┘                                                                           │
│       │ 1. POST /v1/jobs                                                                │
│       │    {type: "agent.run", payload: {prompt: "..."}}                                │
│       ▼                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              API LAYER                                           │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 2. Validation & Creation                                                    │ │   │
│  │  │    ├─ Validate job type against ALLOWED_JOB_TYPES                          │ │   │
│  │  │    ├─ Validate payload against JSON Schema                                 │ │   │
│  │  │    ├─ Check idempotency key                                                │ │   │
│  │  │    └─ Create Job record in PostgreSQL (status=queued)                      │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 3. Queue Job                                                                │ │   │
│  │  │    ├─ LPUSH job_id to Redis queue                                          │ │   │
│  │  │    ├─ HSET job state in Redis                                              │ │   │
│  │  │    └─ Cache idempotency mapping                                            │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                                  │   │
│  │  4. Return HTTP 202 {id, status: "queued", Location header}                     │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ════════════════════════════════════════════════════════════════════════════════════   │
│                              SEPARATE WORKER PROCESS                                     │
│  ════════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              JOBS WORKER                                         │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 5. Poll & Process                                                           │ │   │
│  │  │    ├─ RPOP/BRPOP from Redis queue                                          │ │   │
│  │  │    ├─ Load job from PostgreSQL                                             │ │   │
│  │  │    ├─ Check cancellation flag                                              │ │   │
│  │  │    ├─ Transition: queued → running                                         │ │   │
│  │  │    └─ Start heartbeat task                                                 │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ 6. Execute agent.run Handler                                                │ │   │
│  │  │    ├─ Load/Create AgentRun record                                          │ │   │
│  │  │    ├─ Emit SSE: agent_run_started                                          │ │   │
│  │  │    ├─ Initialize Orchestrator.from_env()                                   │ │   │
│  │  │    ├─ Emit SSE: orchestrator_init                                          │ │   │
│  │  │    ├─ Execute orchestrator.run() with timeout                              │ │   │
│  │  │    │   ├─ Check cancellation between steps ◄──────────────────────┐        │ │   │
│  │  │    │   ├─ Emit SSE per step                                       │        │ │   │
│  │  │    │   └─ LLM calls, MCP tools, Graph queries                     │        │ │   │
│  │  │    ├─ Apply PII scrubbing                                         │        │ │   │
│  │  │    ├─ Apply output guard                                          │        │ │   │
│  │  │    ├─ Emit agent metrics                                          │        │ │   │
│  │  │    └─ Update AgentRun status                                      │        │ │   │
│  │  └────────────────────────────────────────────────────────────────────│────────┘ │   │
│  │  ┌────────────────────────────────────────────────────────────────────│────────┐ │   │
│  │  │ 7. Finalization                                                    │        │ │   │
│  │  │    ├─ Transition: running → finished/failed/cancelled ◄────────────┘        │ │   │
│  │  │    ├─ Persist result to PostgreSQL                                          │ │   │
│  │  │    └─ Emit SSE: completed                                                   │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌──────────┐                                                                           │
│  │  Client  │ 8. GET /v1/jobs/{id}/events (SSE)                                         │
│  └──────────┘    Receives: progress events, heartbeats, final result                    │
│                                                                                          │
│  ┌──────────┐                                                                           │
│  │  Client  │ 9. (Optional) DELETE /v1/jobs/{id} for cancellation                       │
│  └──────────┘    Sets Redis cancellation flag → Worker checks → Transitions to cancelled│
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW ARCHITECTURE                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              WRITE PATH (Agent Runs)                               ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────┐                                                                       │
│   │   Request   │                                                                       │
│   │   (JSON)    │                                                                       │
│   └──────┬──────┘                                                                       │
│          │                                                                               │
│          ▼                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              VALIDATION                                          │  │
│   │   Pydantic Schema ──► CreateRunRequest ──► Validated Input                      │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                               │
│          ├───────────────────────────────────────┬───────────────────────────┐          │
│          │                                       │                           │          │
│          ▼                                       ▼                           ▼          │
│   ┌─────────────┐                       ┌─────────────┐             ┌─────────────┐    │
│   │ PostgreSQL  │                       │    Redis    │             │  Memgraph   │    │
│   │             │                       │             │             │             │    │
│   │ INSERT INTO │                       │ SET session │             │ (if GRAPH   │    │
│   │ agent_runs  │                       │ LPUSH queue │             │  mode)      │    │
│   │             │                       │ HSET state  │             │             │    │
│   └─────────────┘                       └─────────────┘             └─────────────┘    │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              READ PATH (Results)                                   ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              QUERY ROUTING                                       │  │
│   │                                                                                  │  │
│   │   GET /agent-runs/{id}                                                          │  │
│   │         │                                                                        │  │
│   │         ├─► Redis (session/cache check) ──► HIT ──► Return cached              │  │
│   │         │                                     │                                  │  │
│   │         │                                   MISS                                 │  │
│   │         │                                     │                                  │  │
│   │         └─► PostgreSQL (authoritative) ──────┴──► Return + cache                │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              GRAPH DATA FLOW                                       ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐                  │
│   │  Natural Lang   │     │  NL→Cypher      │     │    Memgraph     │                  │
│   │    Question     │────►│   Generator     │────►│    Execution    │                  │
│   │                 │     │   (LLM-based)   │     │                 │                  │
│   └─────────────────┘     └─────────────────┘     └────────┬────────┘                  │
│                                                             │                           │
│                                    ┌────────────────────────┘                           │
│                                    │                                                    │
│                                    ▼                                                    │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐                  │
│   │   NL Response   │◄────│    Response     │◄────│   Query Result  │                  │
│   │   (Formatted)   │     │    Builder      │     │   (Rows/Count)  │                  │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY ARCHITECTURE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                         AUTHENTICATION FLOW (OIDC/JWT)                             ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────────┐         │
│   │  Client  │───►│   Auth0      │───►│   JWT Token  │───►│   API Request    │         │
│   │          │    │ (OIDC IDP)   │    │  (signed)    │    │ + Bearer Token   │         │
│   └──────────┘    └──────────────┘    └──────────────┘    └────────┬─────────┘         │
│                                                                     │                   │
│                                                                     ▼                   │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              JWT VALIDATION                                      │  │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐    │  │
│   │  │  Fetch JWKS   │  │   Verify      │  │   Extract     │  │   Build       │    │  │
│   │  │  (cached)     │──►│  Signature   │──►│  Claims       │──►│  Principal    │    │  │
│   │  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘    │  │
│   │                                                               │                  │  │
│   │                                                               ▼                  │  │
│   │  Principal = {sub, tenant_id, roles: [admin, user], scopes: [read, write]}      │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              AUTHORIZATION (RBAC)                                  ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              PERMISSION CHECK                                    │  │
│   │                                                                                  │  │
│   │   ┌─────────────┐                                                               │  │
│   │   │  Principal  │                                                               │  │
│   │   │  + Action   │                                                               │  │
│   │   └──────┬──────┘                                                               │  │
│   │          │                                                                       │  │
│   │          ▼                                                                       │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                      RBAC ENGINE                                         │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────────────────────────────────────────────────────┐   │   │  │
│   │   │   │  Permission Matrix                                               │   │   │  │
│   │   │   │  ┌────────────────┬──────────┬──────────┬──────────┬──────────┐ │   │   │  │
│   │   │   │  │ Resource       │ admin    │ operator │ user     │ viewer   │ │   │   │  │
│   │   │   │  ├────────────────┼──────────┼──────────┼──────────┼──────────┤ │   │   │  │
│   │   │   │  │ agent-runs     │ CRUD     │ CRU      │ CR       │ R        │ │   │   │  │
│   │   │   │  │ jobs           │ CRUD     │ CRUD     │ CRD      │ R        │ │   │   │  │
│   │   │   │  │ tools          │ CRUD     │ R        │ R        │ R        │ │   │   │  │
│   │   │   │  │ tenants        │ CRUD     │ R        │ -        │ -        │ │   │   │  │
│   │   │   │  │ models         │ CRUD     │ CRU      │ R        │ R        │ │   │   │  │
│   │   │   │  │ graph (write)  │ ✓        │ -        │ -        │ -        │ │   │   │  │
│   │   │   │  │ graph (read)   │ ✓        │ ✓        │ ✓        │ ✓        │ │   │   │  │
│   │   │   │  └────────────────┴──────────┴──────────┴──────────┴──────────┘ │   │   │  │
│   │   │   └─────────────────────────────────────────────────────────────────┘   │   │  │
│   │   │                              │                                           │   │  │
│   │   │                              ▼                                           │   │  │
│   │   │                    ┌───────────────────┐                                │   │  │
│   │   │                    │ ALLOW / DENY (403)│                                │   │  │
│   │   │                    └───────────────────┘                                │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              DATA PROTECTION                                       ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐      │  │
│   │   │   PII SCRUBBER    │    │   OUTPUT GUARD    │    │  RATE LIMITING    │      │  │
│   │   │                   │    │                   │    │                   │      │  │
│   │   │ • Email redaction │    │ • Content filter  │    │ • Per-user limits │      │  │
│   │   │ • Phone masking   │    │ • Injection check │    │ • Per-tenant      │      │  │
│   │   │ • SSN removal     │    │ • Size validation │    │ • Token bucket    │      │  │
│   │   │ • Pattern-based   │    │ • Format verify   │    │ • Redis-backed    │      │  │
│   │   └───────────────────┘    └───────────────────┘    └───────────────────┘      │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              MULTI-TENANCY                                         ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │  │
│   │   │  Tenant A   │    │  Tenant B   │    │  Tenant C   │    │  Tenant D   │     │  │
│   │   ├─────────────┤    ├─────────────┤    ├─────────────┤    ├─────────────┤     │  │
│   │   │ • Users     │    │ • Users     │    │ • Users     │    │ • Users     │     │  │
│   │   │ • Runs      │    │ • Runs      │    │ • Runs      │    │ • Runs      │     │  │
│   │   │ • Jobs      │    │ • Jobs      │    │ • Jobs      │    │ • Jobs      │     │  │
│   │   │ • Config    │    │ • Config    │    │ • Config    │    │ • Config    │     │  │
│   │   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘     │  │
│   │          │                  │                  │                  │            │  │
│   │          └──────────────────┴──────────────────┴──────────────────┘            │  │
│   │                                      │                                          │  │
│   │                                      ▼                                          │  │
│   │                    ┌─────────────────────────────────┐                         │  │
│   │                    │       TENANT ISOLATION          │                         │  │
│   │                    │   (All queries filter by        │                         │  │
│   │                    │    tenant_id from Principal)    │                         │  │
│   │                    └─────────────────────────────────┘                         │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Orchestrator Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ORCHESTRATOR ARCHITECTURE                                   │
│                                  (8,263 Lines of Code)                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              ORCHESTRATOR.run()                                  │  │
│   └────────────────────────────────────┬────────────────────────────────────────────┘  │
│                                        │                                                │
│                                        ▼                                                │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                         PHASE 1: INTENT CLASSIFICATION                             ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   User Goal ──► _classify_user_intent()                                         │  │
│   │                        │                                                         │  │
│   │        ┌───────────────┼───────────────┬───────────────┬───────────────┐        │  │
│   │        │               │               │               │               │        │  │
│   │        ▼               ▼               ▼               ▼               ▼        │  │
│   │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐      │  │
│   │   │  chat   │    │  graph  │    │security │    │  admin  │    │dangerous│      │  │
│   │   │  mode   │    │  mode   │    │  mode   │    │  mode   │    │  mode   │      │  │
│   │   └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘      │  │
│   │        │               │               │               │               │        │  │
│   │        ▼               ▼               ▼               ▼               ▼        │  │
│   │   _handle_      _handle_        _handle_        _handle_        _handle_        │  │
│   │   chat_mode()   graph_mode()    security_mode() admin_mode()    dangerous_mode()│  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                                │
│                                        ▼                                                │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                          PHASE 2: TODO PLANNING                                    ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   _create_agent_todo_list()                                                      │  │
│   │        │                                                                         │  │
│   │        ▼                                                                         │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                       LLM-Based Planning                                 │   │  │
│   │   │                                                                          │   │  │
│   │   │   Input: Goal + Context + Schema                                        │   │  │
│   │   │                    │                                                     │   │  │
│   │   │                    ▼                                                     │   │  │
│   │   │   Output: [                                                              │   │  │
│   │   │     {task: "Analyze query requirements", status: "pending"},            │   │  │
│   │   │     {task: "Generate Cypher query", status: "pending"},                 │   │  │
│   │   │     {task: "Execute and format results", status: "pending"}             │   │  │
│   │   │   ]                                                                      │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   │   Planning Modes:                                                                │  │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐                                     │  │
│   │   │   full   │  │ optional │  │   none   │                                     │  │
│   │   │ (LLM per │  │ (try     │  │(determin-│                                     │  │
│   │   │  TODO)   │  │ direct)  │  │istic)    │                                     │  │
│   │   └──────────┘  └──────────┘  └──────────┘                                     │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                                │
│                                        ▼                                                │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                          PHASE 3: STEP EXECUTION                                   ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   _execute_todo_with_steps()                                                     │  │
│   │                                                                                  │  │
│   │   For each TODO:                                                                 │  │
│   │        │                                                                         │  │
│   │        ├──► requires_llm_planning=False? ──► _execute_memgraph_direct_todo()    │  │
│   │        │                                                                         │  │
│   │        └──► requires_llm_planning=True? ──► LLM plan + execute steps            │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                      STEP EXECUTION ENGINE                               │   │  │
│   │   │                                                                          │   │  │
│   │   │   Step Types:                                                            │   │  │
│   │   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐               │   │  │
│   │   │   │   llm:call    │  │  tool:invoke  │  │ graph:query   │               │   │  │
│   │   │   │               │  │               │  │               │               │   │  │
│   │   │   │ • planner     │  │ • MCP tools   │  │ • NL→Cypher   │               │   │  │
│   │   │   │ • reflector   │  │ • 34 tools    │  │ • Execute     │               │   │  │
│   │   │   │ • responder   │  │ • RBAC check  │  │ • Format      │               │   │  │
│   │   │   └───────────────┘  └───────────────┘  └───────────────┘               │   │  │
│   │   │                                                                          │   │  │
│   │   │   Each step records: {id, action, input, output, latency_ms}            │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                                │
│                                        ▼                                                │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                         PHASE 4: RESPONSE GENERATION                               ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   build_memgraph_nl_response() / build_chat_response()                          │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │   Response Modes:                                                        │   │  │
│   │   │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │   │  │
│   │   │   │ fallback-only  │  │ llm-best-effort│  │  llm-required  │            │   │  │
│   │   │   │ (deterministic)│  │ (try LLM)      │  │ (LLM always)   │            │   │  │
│   │   │   └────────────────┘  └────────────────┘  └────────────────┘            │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   │   Output: OrchestrationResult {                                                  │  │
│   │     goal, started_at, finished_at,                                              │  │
│   │     steps: [...], outputs: [...], todos: [...],                                 │  │
│   │     metrics: {overall_ms, llm_calls, tool_calls, ...}                           │  │
│   │   }                                                                              │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## MCP Tools Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         MCP TOOLS ARCHITECTURE (34 Tools)                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              TOOL CATEGORIES (17)                                  ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐            │
│   │     GRAPH       │    SECURITY     │     SYSTEM      │     CACHE       │            │
│   ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤            │
│   │ • query         │ • describe_     │ • health        │ • get           │            │
│   │ • secure_query  │   principal     │ • metrics       │ • set           │            │
│   │ • generate_     │ • allowed_      │ • config        │ • delete        │            │
│   │   cypher        │   operations    │ • status        │ • invalidate    │            │
│   │ • schema        │ • validate      │                 │                 │            │
│   │ • explain       │                 │                 │                 │            │
│   └─────────────────┴─────────────────┴─────────────────┴─────────────────┘            │
│                                                                                          │
│   ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐            │
│   │    CATALOG      │     MODEL       │     AGENT       │   ANALYTICS     │            │
│   ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤            │
│   │ • discover      │ • list          │ • context       │ • query         │            │
│   │ • describe      │ • info          │ • history       │ • aggregate     │            │
│   │ • search        │ • warmup        │ • state         │ • visualize     │            │
│   │                 │ • switch        │                 │                 │            │
│   └─────────────────┴─────────────────┴─────────────────┴─────────────────┘            │
│                                                                                          │
│   ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐            │
│   │     ADMIN       │      ETL        │      CRUD       │    EXPORT       │            │
│   ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤            │
│   │ • create_index  │ • import        │ • create_node   │ • csv           │            │
│   │ • drop_index    │ • export        │ • update_node   │ • json          │            │
│   │ • constraint    │ • transform     │ • delete_node   │ • cypher        │            │
│   └─────────────────┴─────────────────┴─────────────────┴─────────────────┘            │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              MCP RUNTIME                                           ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌───────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │                        TOOL INVOCATION FLOW                                │ │  │
│   │   │                                                                            │ │  │
│   │   │   Request ──► Schema Validation ──► RBAC Check ──► Execute ──► Audit Log  │ │  │
│   │   │                                                                            │ │  │
│   │   │   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌────────┐ │ │  │
│   │   │   │ Payload  │──►│  JSON    │──►│ Principal│──►│   Tool   │──►│ Result │ │ │  │
│   │   │   │ (JSON)   │   │  Schema  │   │  + ACL   │   │  Handler │   │ + Logs │ │ │  │
│   │   │   └──────────┘   └──────────┘   └──────────┘   └──────────┘   └────────┘ │ │  │
│   │   │                                                                            │ │  │
│   │   └───────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │   ┌───────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │                        TOOL MANIFEST (from DB)                             │ │  │
│   │   │                                                                            │ │  │
│   │   │   {                                                                        │ │  │
│   │   │     "name": "graph.query",                                                 │ │  │
│   │   │     "description": "Execute a Cypher query...",                            │ │  │
│   │   │     "input_schema": {...},                                                 │ │  │
│   │   │     "required_scopes": ["graph:read"],                                     │ │  │
│   │   │     "rate_limit": {"requests": 100, "window": 60}                          │ │  │
│   │   │   }                                                                        │ │  │
│   │   └───────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Background Jobs Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         BACKGROUND JOBS ARCHITECTURE                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              JOB QUEUE SYSTEM                                      ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   API Layer                              Redis                                   │  │
│   │   ┌───────────────┐                     ┌───────────────────────────────────┐   │  │
│   │   │ POST /v1/jobs │────────────────────►│ LPUSH jobs:queue:{type}           │   │  │
│   │   │               │                     │ HSET jobs:state:{id}              │   │  │
│   │   │ {type, payload}                     │ SET jobs:idempotency:{key}        │   │  │
│   │   └───────────────┘                     └───────────────────────────────────┘   │  │
│   │          │                                              │                       │  │
│   │          │                                              │                       │  │
│   │          ▼                                              │                       │  │
│   │   ┌───────────────┐                                     │                       │  │
│   │   │  PostgreSQL   │                                     │                       │  │
│   │   │ INSERT job    │                                     │                       │  │
│   │   │ (authoritative)                                     │                       │  │
│   │   └───────────────┘                                     │                       │  │
│   │                                                         │                       │  │
│   │   ═══════════════════════════════════════════════════════                       │  │
│   │                                                         │                       │  │
│   │   Worker Process                                        │                       │  │
│   │   ┌───────────────────────────────────────────────────┐ │                       │  │
│   │   │                                                   │ │                       │  │
│   │   │   ┌─────────────────────────────────────────────┐ │ │                       │  │
│   │   │   │              POLL LOOP                       │◄┼───────────────────────┘  │
│   │   │   │                                              │ │                          │
│   │   │   │   while True:                                │ │                          │
│   │   │   │     job_id = BRPOP jobs:queue:{type}        │ │                          │
│   │   │   │     job = load_from_postgres(job_id)        │ │                          │
│   │   │   │     if not cancelled:                        │ │                          │
│   │   │   │       execute_handler(job)                   │ │                          │
│   │   │   │                                              │ │                          │
│   │   │   └─────────────────────────────────────────────┘ │                          │
│   │   │                        │                          │                          │
│   │   │                        ▼                          │                          │
│   │   │   ┌─────────────────────────────────────────────┐ │                          │
│   │   │   │              JOB HANDLERS                    │ │                          │
│   │   │   │                                              │ │                          │
│   │   │   │   ┌────────────┐  ┌────────────┐            │ │                          │
│   │   │   │   │   demo     │  │   test     │            │ │                          │
│   │   │   │   └────────────┘  └────────────┘            │ │                          │
│   │   │   │   ┌────────────┐  ┌────────────┐            │ │                          │
│   │   │   │   │long-running│  │ agent.run  │ ◄── NEW!   │ │                          │
│   │   │   │   └────────────┘  └────────────┘            │ │                          │
│   │   │   │                                              │ │                          │
│   │   │   └─────────────────────────────────────────────┘ │                          │
│   │   │                        │                          │                          │
│   │   │                        ▼                          │                          │
│   │   │   ┌─────────────────────────────────────────────┐ │                          │
│   │   │   │              SSE EVENTS                      │ │                          │
│   │   │   │                                              │ │                          │
│   │   │   │   RPUSH jobs:events:{id} {event_json}       │ │                          │
│   │   │   │                                              │ │                          │
│   │   │   │   Events: progress, status, heartbeat,      │ │                          │
│   │   │   │           completed                          │ │                          │
│   │   │   └─────────────────────────────────────────────┘ │                          │
│   │   │                                                   │                          │
│   │   └───────────────────────────────────────────────────┘                          │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                           BACKGROUND TASKS (Scheduled)                             ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │  │
│   │   │  Health Check   │    │    Cleanup      │    │     Backup      │            │  │
│   │   │  (every 30s)    │    │   (hourly)      │    │    (daily)      │            │  │
│   │   │                 │    │                 │    │                 │            │  │
│   │   │ • DB ping       │    │ • Expired jobs  │    │ • PostgreSQL    │            │  │
│   │   │ • Redis ping    │    │ • Old sessions  │    │ • Redis RDB     │            │  │
│   │   │ • Memgraph ping │    │ • Stale caches  │    │ • Audit logs    │            │  │
│   │   │ • LLM warmup    │    │ • Orphan runs   │    │                 │            │  │
│   │   └─────────────────┘    └─────────────────┘    └─────────────────┘            │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Observability Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         OBSERVABILITY ARCHITECTURE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              METRICS (Prometheus)                                  ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │   FastAPI App                               Prometheus                           │  │
│   │   ┌───────────────────────┐               ┌───────────────────────┐            │  │
│   │   │ /metrics endpoint     │◄──────────────│ Scrape every 15s      │            │  │
│   │   │                       │               │                       │            │  │
│   │   │ Metrics:              │               │ Storage: TSDB         │            │  │
│   │   │ • agent_run_*         │               │ Retention: 15d        │            │  │
│   │   │ • job_*               │               │                       │            │  │
│   │   │ • llm_call_*          │               └───────────┬───────────┘            │  │
│   │   │ • tool_invocation_*   │                           │                         │  │
│   │   │ • http_request_*      │                           │                         │  │
│   │   │ • db_query_*          │                           ▼                         │  │
│   │   └───────────────────────┘               ┌───────────────────────┐            │  │
│   │                                           │ Grafana               │            │  │
│   │   Custom Metrics:                         │                       │            │  │
│   │   ┌───────────────────────┐               │ Dashboards:           │            │  │
│   │   │ agent_run_duration_   │               │ • Platform Overview   │            │  │
│   │   │   seconds_histogram   │               │ • Agent Performance   │            │  │
│   │   │ agent_run_success_    │               │ • LLM Provider Status │            │  │
│   │   │   total_counter       │               │ • Error Rates         │            │  │
│   │   │ llm_tokens_used_total │               └───────────────────────┘            │  │
│   │   └───────────────────────┘                                                     │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              TRACING (OpenTelemetry)                               ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                        DISTRIBUTED TRACE                                 │   │  │
│   │   │                                                                          │   │  │
│   │   │   trace_id: abc-123                                                      │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌──────────────┐                                                      │   │  │
│   │   │   │ API Request  │ span_id: 001                                         │   │  │
│   │   │   └──────┬───────┘                                                      │   │  │
│   │   │          │                                                               │   │  │
│   │   │          ├──► ┌──────────────┐                                          │   │  │
│   │   │          │    │ Auth/RBAC    │ span_id: 002, parent: 001               │   │  │
│   │   │          │    └──────────────┘                                          │   │  │
│   │   │          │                                                               │   │  │
│   │   │          ├──► ┌──────────────┐                                          │   │  │
│   │   │          │    │ Orchestrator │ span_id: 003, parent: 001               │   │  │
│   │   │          │    └──────┬───────┘                                          │   │  │
│   │   │          │           │                                                   │   │  │
│   │   │          │           ├──► ┌──────────────┐                              │   │  │
│   │   │          │           │    │ LLM Call     │ span_id: 004, parent: 003   │   │  │
│   │   │          │           │    └──────────────┘                              │   │  │
│   │   │          │           │                                                   │   │  │
│   │   │          │           └──► ┌──────────────┐                              │   │  │
│   │   │          │                │ Graph Query  │ span_id: 005, parent: 003   │   │  │
│   │   │          │                └──────────────┘                              │   │  │
│   │   │          │                                                               │   │  │
│   │   │          └──► ┌──────────────┐                                          │   │  │
│   │   │               │ DB Persist   │ span_id: 006, parent: 001               │   │  │
│   │   │               └──────────────┘                                          │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                            │                                     │  │
│   │                                            ▼                                     │  │
│   │                               ┌───────────────────────┐                         │  │
│   │                               │  Jaeger / Zipkin      │                         │  │
│   │                               │  (Trace Collector)    │                         │  │
│   │                               └───────────────────────┘                         │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              LOGGING (Structured)                                  ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Log Format (JSON):                                                            │  │
│   │   {                                                                              │  │
│   │     "timestamp": "2026-01-23T10:30:00Z",                                        │  │
│   │     "level": "INFO",                                                            │  │
│   │     "event": "agent_run.completed",                                             │  │
│   │     "run_id": "550e8400-...",                                                   │  │
│   │     "user_id": "user@example.com",                                              │  │
│   │     "tenant_id": "default",                                                     │  │
│   │     "trace_id": "abc-123",                                                      │  │
│   │     "latency_ms": 1234,                                                         │  │
│   │     "status": "succeeded"                                                       │  │
│   │   }                                                                              │  │
│   │                                                                                  │  │
│   │   Log Levels: DEBUG, INFO, WARNING, ERROR, CRITICAL                             │  │
│   │                                                                                  │  │
│   │   Log Destinations:                                                             │  │
│   │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                         │  │
│   │   │   stdout     │  │    File      │  │    ELK       │                         │  │
│   │   │   (Docker)   │  │   Rotation   │  │   (optional) │                         │  │
│   │   └──────────────┘  └──────────────┘  └──────────────┘                         │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                              HEALTH PROBES                                         ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌─────────────────────┐    ┌─────────────────────┐    ┌──────────────────┐   │  │
│   │   │ /v1/health/live     │    │ /v1/health/ready    │    │ /v1/health/      │   │  │
│   │   │                     │    │                     │    │   components     │   │  │
│   │   │ Kubernetes:         │    │ Kubernetes:         │    │                  │   │  │
│   │   │ livenessProbe       │    │ readinessProbe      │    │ Component status │   │  │
│   │   │                     │    │                     │    │ • postgres: ok   │   │  │
│   │   │ Returns: 200 OK     │    │ Checks:             │    │ • redis: ok      │   │  │
│   │   │ if process alive    │    │ • DB connection     │    │ • memgraph: ok   │   │  │
│   │   │                     │    │ • Redis ping        │    │ • llm: degraded  │   │  │
│   │   │                     │    │ • Orchestrator ready│    │                  │   │  │
│   │   └─────────────────────┘    └─────────────────────┘    └──────────────────┘   │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Topology

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         DEPLOYMENT TOPOLOGY (Docker Compose)                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              DOCKER NETWORK: cineca-platform                     │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                           FRONTEND TIER                                  │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────────┐       ┌─────────────────────┐                 │   │  │
│   │   │   │     nginx           │       │    ui_agent         │                 │   │  │
│   │   │   │    (Port 80/443)    │       │   (Port 3002)       │                 │   │  │
│   │   │   │                     │       │                     │                 │   │  │
│   │   │   │   Reverse Proxy     │       │   Next.js           │                 │   │  │
│   │   │   │   SSL Termination   │       │   Agent Chat UI     │                 │   │  │
│   │   │   └─────────────────────┘       └─────────────────────┘                 │   │  │
│   │   │                                                                          │   │  │
│   │   │                         ┌─────────────────────┐                         │   │  │
│   │   │                         │  ui_control_panel   │                         │   │  │
│   │   │                         │    (Port 8501)      │                         │   │  │
│   │   │                         │                     │                         │   │  │
│   │   │                         │   Streamlit         │                         │   │  │
│   │   │                         │   Admin Panel       │                         │   │  │
│   │   │                         └─────────────────────┘                         │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                            │                                     │  │
│   │                                            ▼                                     │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                          APPLICATION TIER                                │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────────────────────────────────────────────────────┐   │   │  │
│   │   │   │                        app (FastAPI)                             │   │   │  │
│   │   │   │                         (Port 8000)                              │   │   │  │
│   │   │   │                                                                  │   │   │  │
│   │   │   │   Container: uvicorn src.app:app --host 0.0.0.0 --port 8000    │   │   │  │
│   │   │   │                                                                  │   │   │  │
│   │   │   │   Resources: 2 CPU, 4GB RAM                                     │   │   │  │
│   │   │   │   Health: /v1/health/ready                                      │   │   │  │
│   │   │   │   Replicas: 2 (production)                                      │   │   │  │
│   │   │   └─────────────────────────────────────────────────────────────────┘   │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────────────────────────────────────────────────────┐   │   │  │
│   │   │   │                       worker (Jobs Worker)                       │   │   │  │
│   │   │   │                                                                  │   │   │  │
│   │   │   │   Container: python -m src.workers.jobs_worker                  │   │   │  │
│   │   │   │                                                                  │   │   │  │
│   │   │   │   Resources: 2 CPU, 4GB RAM                                     │   │   │  │
│   │   │   │   Replicas: 1-N (auto-scale based on queue depth)               │   │   │  │
│   │   │   └─────────────────────────────────────────────────────────────────┘   │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                            │                                     │  │
│   │                                            ▼                                     │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                            DATA TIER                                     │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │  │
│   │   │   │    postgres     │ │     redis       │ │    memgraph     │           │   │  │
│   │   │   │   (Port 5432)   │ │   (Port 6379)   │ │   (Port 7687)   │           │   │  │
│   │   │   │                 │ │                 │ │                 │           │   │  │
│   │   │   │ PostgreSQL 15   │ │ Redis 7         │ │ Memgraph 2.x    │           │   │  │
│   │   │   │                 │ │                 │ │                 │           │   │  │
│   │   │   │ Volume:         │ │ Volume:         │ │ Volume:         │           │   │  │
│   │   │   │ pg_data         │ │ redis_data      │ │ mg_data         │           │   │  │
│   │   │   │                 │ │                 │ │                 │           │   │  │
│   │   │   │ Resources:      │ │ Resources:      │ │ Resources:      │           │   │  │
│   │   │   │ 2 CPU, 2GB RAM  │ │ 1 CPU, 1GB RAM  │ │ 2 CPU, 4GB RAM  │           │   │  │
│   │   │   └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                            │                                     │  │
│   │                                            ▼                                     │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                         MONITORING TIER                                  │   │  │
│   │   │                                                                          │   │  │
│   │   │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │   │  │
│   │   │   │   prometheus    │ │     grafana     │ │     jaeger      │           │   │  │
│   │   │   │   (Port 9090)   │ │   (Port 3000)   │ │  (Port 16686)   │           │   │  │
│   │   │   │                 │ │                 │ │                 │           │   │  │
│   │   │   │ Metrics scraper │ │ Dashboards      │ │ Trace collector │           │   │  │
│   │   │   └─────────────────┘ └─────────────────┘ └─────────────────┘           │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                           EXTERNAL SERVICES                                        ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐                    │
│   │     Auth0       │    │   OpenAI API    │    │     Ollama      │                    │
│   │   (OIDC IDP)    │    │ (LLM Provider)  │    │ (Local LLM)     │                    │
│   │                 │    │                 │    │                 │                    │
│   │ • JWT Signing   │    │ • gpt-4         │    │ • llama-3.2     │                    │
│   │ • JWKS Endpoint │    │ • gpt-3.5-turbo │    │ • phi-3         │                    │
│   │ • User Mgmt     │    │                 │    │ • mistral       │                    │
│   └─────────────────┘    └─────────────────┘    └─────────────────┘                    │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Database Schema Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE SCHEMA OVERVIEW                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                          POSTGRESQL (Control Plane)                                ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   ┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐  │  │
│   │   │    tenants      │◄────────│   agent_runs    │────────►│     steps       │  │  │
│   │   │                 │         │                 │         │                 │  │  │
│   │   │ id (PK)         │         │ id (PK)         │         │ id (PK)         │  │  │
│   │   │ name            │         │ tenant_id (FK)  │         │ run_id (FK)     │  │  │
│   │   │ config          │         │ session_id (FK) │         │ action          │  │  │
│   │   │ created_at      │         │ user_id         │         │ input           │  │  │
│   │   │ updated_at      │         │ status          │         │ output          │  │  │
│   │   └─────────────────┘         │ prompt          │         │ latency_ms      │  │  │
│   │                               │ output          │         │ started_at      │  │  │
│   │                               │ todos           │         │ finished_at     │  │  │
│   │   ┌─────────────────┐         │ metrics         │         └─────────────────┘  │  │
│   │   │    sessions     │◄────────│ started_at      │                              │  │
│   │   │                 │         │ finished_at     │                              │  │
│   │   │ id (PK)         │         └─────────────────┘                              │  │
│   │   │ tenant_id (FK)  │                                                          │  │
│   │   │ user_id         │         ┌─────────────────┐         ┌─────────────────┐  │  │
│   │   │ context         │         │      jobs       │────────►│   job_events    │  │  │
│   │   │ created_at      │         │                 │         │                 │  │  │
│   │   └─────────────────┘         │ id (PK)         │         │ id (PK)         │  │  │
│   │                               │ tenant_id (FK)  │         │ job_id (FK)     │  │  │
│   │                               │ owner           │         │ event_type      │  │  │
│   │   ┌─────────────────┐         │ type            │         │ data            │  │  │
│   │   │  tool_manifests │         │ status          │         │ timestamp       │  │  │
│   │   │                 │         │ payload         │         └─────────────────┘  │  │
│   │   │ id (PK)         │         │ result          │                              │  │
│   │   │ tenant_id (FK)  │         │ created_at      │                              │  │
│   │   │ name            │         │ finished_at     │                              │  │
│   │   │ version         │         └─────────────────┘                              │  │
│   │   │ schema          │                                                          │  │
│   │   │ description     │         ┌─────────────────┐         ┌─────────────────┐  │  │
│   │   └─────────────────┘         │  model_defaults │         │   audit_logs    │  │  │
│   │                               │                 │         │                 │  │  │
│   │                               │ id (PK)         │         │ id (PK)         │  │  │
│   │                               │ scope           │         │ tenant_id (FK)  │  │  │
│   │                               │ tenant_id (FK)  │         │ user_id         │  │  │
│   │                               │ instance_id     │         │ action          │  │  │
│   │                               │ priority        │         │ resource_type   │  │  │
│   │                               └─────────────────┘         │ resource_id     │  │  │
│   │                                                           │ details         │  │  │
│   │                                                           │ timestamp       │  │  │
│   │                                                           └─────────────────┘  │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                             REDIS (Data Plane)                                     ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Key Patterns:                                                                  │  │
│   │                                                                                  │  │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │  │
│   │   │   CACHE                                                                 │    │  │
│   │   │   • session:{id}           → Session context (JSON)                    │    │  │
│   │   │   • response:{hash}        → Cached response (JSON)                    │    │  │
│   │   │   • tool_result:{hash}     → Cached tool result (JSON)                 │    │  │
│   │   │   • model_warmup:{name}    → Model warmup status                       │    │  │
│   │   └────────────────────────────────────────────────────────────────────────┘    │  │
│   │                                                                                  │  │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │  │
│   │   │   QUEUES                                                                │    │  │
│   │   │   • jobs:queue:{type}      → Job queue (LIST)                          │    │  │
│   │   │   • jobs:state:{id}        → Job state (HASH)                          │    │  │
│   │   │   • jobs:events:{id}       → SSE event ring (LIST)                     │    │  │
│   │   └────────────────────────────────────────────────────────────────────────┘    │  │
│   │                                                                                  │  │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │  │
│   │   │   RATE LIMITING                                                         │    │  │
│   │   │   • rate:{user}:{action}   → Token bucket (HASH)                       │    │  │
│   │   │   • rate:{tenant}:{action} → Tenant-level limit (HASH)                 │    │  │
│   │   └────────────────────────────────────────────────────────────────────────┘    │  │
│   │                                                                                  │  │
│   │   ┌────────────────────────────────────────────────────────────────────────┐    │  │
│   │   │   CONTROL                                                               │    │  │
│   │   │   • idempotency:{key}      → Request hash (STRING, TTL)                │    │  │
│   │   │   • cancel:{job_id}        → Cancellation flag (STRING)                │    │  │
│   │   │   • circuit:{provider}     → Circuit breaker state (HASH)              │    │  │
│   │   └────────────────────────────────────────────────────────────────────────┘    │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   ╔═══════════════════════════════════════════════════════════════════════════════════╗ │
│   ║                            MEMGRAPH (Graph Domain)                                 ║ │
│   ╚═══════════════════════════════════════════════════════════════════════════════════╝ │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                  │  │
│   │   Graph Schema:                                                                  │  │
│   │                                                                                  │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                                                                          │   │  │
│   │   │      (:User)                    (:Project)                              │   │  │
│   │   │         │                            │                                   │   │  │
│   │   │         │ [:OWNS]                   │ [:CONTAINS]                       │   │  │
│   │   │         ▼                            ▼                                   │   │  │
│   │   │      (:Task) ──[:DEPENDS_ON]──► (:Task)                                 │   │  │
│   │   │         │                            │                                   │   │  │
│   │   │         │ [:ASSIGNED_TO]            │ [:TAGGED_WITH]                    │   │  │
│   │   │         ▼                            ▼                                   │   │  │
│   │   │      (:Team)                     (:Label)                               │   │  │
│   │   │                                                                          │   │  │
│   │   │   Node Properties:                                                       │   │  │
│   │   │   • id, name, status, created_at, updated_at                            │   │  │
│   │   │   • Domain-specific: dbname, blast_type, output_result, etc.            │   │  │
│   │   │                                                                          │   │  │
│   │   │   Indexes:                                                               │   │  │
│   │   │   • CREATE INDEX ON :User(id)                                           │   │  │
│   │   │   • CREATE INDEX ON :Task(status)                                       │   │  │
│   │   │   • CREATE INDEX ON :Project(name)                                      │   │  │
│   │   │                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Key Statistics

| Component | Metric |
|-----------|--------|
| **Total Lines of Code** | ~77,000 |
| **Orchestrator LOC** | 8,263 |
| **API Endpoints** | 76 |
| **MCP Tools** | 34 (17 categories) |
| **Test Functions** | 2,700+ |
| **Test Files** | 236 |
| **Docker Services** | 10+ |
| **Database Tables** | 12+ |
| **Redis Key Patterns** | 15+ |

---

## References

- [README.md](../../README.md) - Project overview
- [WORKFLOW_A.md](../workflows/WORKFLOW_A.md) - Synchronous execution details
- [WORKFLOW_B.md](../workflows/WORKFLOW_B.md) - Asynchronous job execution
- [sapthesis-doc.tex](../general/sapthesis/sapthesis-doc.tex) - Full thesis documentation
